name: Deploy via Self-Hosted Runner

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to cPanel Server
    runs-on: self-hosted
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install --force

      - name: Build project
        run: npm run build

      - name: Start app using PM2 (or fallback to plain Node)
        run: |
          if command -v pm2 >/dev/null 2>&1; then
            pm2 start .next/standalone/server.js --name next-drizzle || pm2 restart next-drizzle
            pm2 save
          else
            nohup node .next/standalone/server.js > out.log 2>&1 &
          fi
