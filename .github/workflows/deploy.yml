name: Deploy via Self-Hosted Runner

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to cPanel Server
    runs-on: self-hosted

    steps:
      - name: ðŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "Installing npm dependencies..."
          npm install --force
          echo "âœ… Dependencies installed."

      - name: ðŸ› ï¸ Build Next.js app
        run: |
          echo "Building the project..."
          npm run build
          echo "âœ… Build complete."

      - name: ðŸš€ Start or restart app
        run: |
          echo "Checking if pm2 is installed..."
          if command -v pm2 >/dev/null 2>&1; then
            echo "âœ… pm2 is available. Managing process with pm2..."
            pm2 start .next/standalone/server.js --name next-drizzle || pm2 restart next-drizzle
            pm2 save
            pm2 list
          else
            echo "âš ï¸ pm2 not found. Falling back to nohup..."
            nohup node .next/standalone/server.js > out.log 2>&1 &
            echo "âœ… App started using plain Node.js (background)."
          fi
